<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Twilio Voice Test</title>
    <script src="https://sdk.twilio.com/js/client/v1.13/twilio.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-neutral-900 text-neutral-100 min-h-screen flex items-center justify-center px-6">
    <div class="bg-neutral-800 shadow-2xl rounded-3xl p-10 w-full max-w-2xl space-y-8">
        <h2 class="text-3xl font-semibold text-center text-neutral-100">Twilio Voice over IP</h2>

        <!-- Identity Input -->
        <div class="space-y-3">
            <input id="identity" placeholder="Enter your identity"
                class="w-full px-5 py-3 bg-neutral-700 border border-neutral-600 rounded-xl placeholder-neutral-400 text-base focus:outline-none focus:ring-2 focus:ring-neutral-500" />
            <button onclick="getToken()"
                class="w-full py-3 rounded-xl bg-neutral-600 hover:bg-neutral-500 text-neutral-100 transition text-base font-medium">Get
                Token</button>
        </div>

        <!-- To Input -->
        <div class="space-y-3">
            <input id="to" placeholder="Call To (e.g., +1234567890 or client identity)"
                class="w-full px-5 py-3 bg-neutral-700 border border-neutral-600 rounded-xl placeholder-neutral-400 text-base focus:outline-none focus:ring-2 focus:ring-neutral-500" />
            <div class="flex space-x-4">
                <button onclick="makeCall()"
                    class="w-1/2 py-3 rounded-xl bg-neutral-600 hover:bg-neutral-500 text-neutral-100 transition text-base font-medium">Call</button>
                <button onclick="hangup()"
                    class="w-1/2 py-3 rounded-xl bg-neutral-700 hover:bg-neutral-600 text-neutral-300 transition text-base font-medium border border-neutral-600">Hang
                    Up</button>
            </div>
        </div>

        <!-- Log Message -->
        <div id="log" class="text-base text-neutral-300 text-center pt-4"></div>
    </div>

    <!-- ⚠️ Script remains unchanged -->
    <script>
        let device;
        let currentConnection;

        function log(msg) {
            document.getElementById('log').innerText = msg;
            console.log(msg);
        }

        async function getToken() {
            const identity = document.getElementById('identity').value;
            if (!identity) return log("Please enter an identity first.");

            try {
                const response = await fetch(`/token?identity=${encodeURIComponent(identity)}`);
                const data = await response.json();
                if (!data.token) throw new Error("No token received");

                log("Token received. Initializing device...");

                device = new Twilio.Device(data.token, {
                    codecPreferences: ["opus", "pcmu"],
                    fakeLocalDTMF: true,
                    enableRingingState: true
                });

                device.on("ready", () => log("Device ready!"));
                device.on("error", (error) => log("Device error: " + error.message));
                device.on("connect", (conn) => {
                    log("Call connected");
                    currentConnection = conn;
                });
                device.on("disconnect", () => {
                    log("Call disconnected");
                    currentConnection = null;
                });

                device.on("incoming", (conn) => {
                    log("Incoming call from: " + conn.parameters.From);
                    if (confirm(`Accept call from ${conn.parameters.From}?`)) {
                        conn.accept();
                    } else {
                        conn.reject();
                    }
                });

            } catch (err) {
                log("Failed to get token: " + err.message);
            }
        }

        function makeCall() {
            const to = document.getElementById("to").value;
            if (!to || !device) return log("Please enter 'To' and initialize the device.");

            const connection = device.connect({ To: to });
            currentConnection = connection;
            log("Calling " + to + "...");
        }

        function hangup() {
            if (currentConnection) {
                currentConnection.disconnect();
            } else if (device) {
                device.disconnectAll();
            }
            log("Call ended.");
        }
    </script>
</body>

</html>